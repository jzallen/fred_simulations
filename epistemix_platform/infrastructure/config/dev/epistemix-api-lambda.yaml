template:
  type: file
  path: lambda/epistemix-api-lambda.json

stack_name: epistemix-api-lambda-dev

# Dependencies - External stacks (ECR, RDS, S3) must exist before deploying
# Note: API Gateway depends on Lambda, so Lambda is deployed first without API Gateway permission
# After API Gateway is created, update Lambda stack to add the permission
dependencies: []

# Stack parameters for development environment
parameters:
  Environment: dev
  ServiceName: epistemix-api
  # ECR image URI (will be: 170692816356.dkr.ecr.us-east-1.amazonaws.com/epistemix-api:latest)
  # NOTE: Update this after creating ECR repo and pushing image
  ECRImageUri: "170692816356.dkr.ecr.us-east-1.amazonaws.com/epistemix-api:latest"
  # VPC configuration
  VPCId: "vpc-00bb33feebfb59191"
  VPCSubnetIds: "subnet-0c6dc4a43d6d2269c,subnet-0065bf40913be1672"
  # RDS connection parameters (from external stack: fred-simulations-dev-rds-postgres)
  DBSecurityGroupId: "sg-0623cab92420d3a59"
  DBHost: "fred-simulations-dev-rds-postgres-dbinstance-8bu9adm1kzju.c2tsguye2mmq.us-east-1.rds.amazonaws.com"
  DBPort: "5432"
  DBName: "epistemixdb"
  DBUser: "epistemixuser"
  DBPassword: !environment_variable EPISTEMIX_DB_PASSWORD
  # S3 bucket (from external stack: epistemix-uploads-dev-stack)
  S3BucketName: "epistemix-uploads-dev"
  MemorySize: 3008
  Timeout: 30
  ApiGatewayRestApiId: "jxghhxhvvl"

# Stack-specific tags
tags:
  Owner: fred-simulations
  CostCenter: Development
  Component: Lambda
  Service: EpistemixAPI

# Sceptre hooks for template validation
hooks:
  before_validate:
    - !cmd "echo '▶ (epistemix-api-lambda) Running cfn-lint...' && cfn-lint templates/lambda/epistemix-api-lambda.json && echo '✓ (epistemix-api-lambda) cfn-lint passed'"
    - !cmd "echo '▶ (epistemix-api-lambda) Running cfn-guard security validation...' && cfn-guard validate --data templates/lambda/epistemix-api-lambda.json --rules guard_rules/lambda_security_rules.guard --show-summary fail && echo '✓ (epistemix-api-lambda) cfn-guard passed'"
  before_create:
    - !cmd "echo '▶ (epistemix-api-lambda) Running cfn-lint...' && cfn-lint templates/lambda/epistemix-api-lambda.json && echo '✓ (epistemix-api-lambda) cfn-lint passed'"
    - !cmd "echo '▶ (epistemix-api-lambda) Running cfn-guard security validation...' && cfn-guard validate --data templates/lambda/epistemix-api-lambda.json --rules guard_rules/lambda_security_rules.guard --show-summary fail && echo '✓ (epistemix-api-lambda) cfn-guard passed'"
  before_update:
    - !cmd "echo '▶ (epistemix-api-lambda) Running cfn-lint...' && cfn-lint templates/lambda/epistemix-api-lambda.json && echo '✓ (epistemix-api-lambda) cfn-lint passed'"
    - !cmd "echo '▶ (epistemix-api-lambda) Running cfn-guard security validation...' && cfn-guard validate --data templates/lambda/epistemix-api-lambda.json --rules guard_rules/lambda_security_rules.guard --show-summary fail && echo '✓ (epistemix-api-lambda) cfn-guard passed'"
