template:
  type: file
  path: batch/batch-infrastructure.json

# Layer 4: Batch infrastructure depends on VPC, S3, Secrets Manager, and ECR
dependencies:
  - dev/database-secrets.yaml
  - dev/s3-upload-bucket.yaml
  - docker-images/simulation-runner-ecr.yaml

# Stack parameters for development environment
parameters:
  Environment: dev

  # Network Configuration
  # IMPORTANT: These are default VPC values - update with actual private subnets when available
  VpcId: vpc-00bb33feebfb59191
  SubnetIds: subnet-0c6dc4a43d6d2269c,subnet-0065bf40913be1672

  # ECR Repository
  # NOTE: Update this after ECR stack is created
  # Format: {account-id}.dkr.ecr.{region}.amazonaws.com/{repository-name}
  ECRRepositoryUri: !stack_output docker-images/simulation-runner-ecr.yaml::RepositoryUri

  # Database Secret
  # References the existing database-secrets stack
  DatabaseSecretArn: !stack_output dev/database-secrets.yaml::SecretArn

  # S3 Buckets
  # Upload bucket already exists, results bucket needs to be created
  UploadBucketName: !stack_output dev/s3-upload-bucket.yaml::BucketName
  ResultsBucketName: epistemix-results-dev  # TODO: Create results bucket stack

  # Compute Environment Configuration
  # Based on ENGINEER-01's learnings (ADR-003):
  # - EC2 SPOT instances for 70% cost savings
  # - c5.xlarge (4 vCPU, 8 GB) for FRED simulations
  # - Max 256 vCPUs = ~64 concurrent jobs
  MaxvCpus: 256
  SpotBidPercentage: 100  # Use Spot whenever available (fallback to On-Demand)

  # CloudWatch Logs
  # Short retention for dev environment (7 days)
  LogRetentionDays: 7

# Stack-specific tags
tags:
  Owner: fred-simulations
  CostCenter: Development
  Component: Batch
  Service: FredSimulations
  Purpose: ComputeOrchestration

# Sceptre hooks for template validation
validation_hooks: &validation_hooks
  - !cmd |
    echo '▶ (batch-infrastructure) Running cfn-lint...' && \
    cfn-lint templates/batch/batch-infrastructure.json && \
    echo '✓ (batch-infrastructure) cfn-lint passed'
  # NOTE: cfn-guard rules for Batch can be added later
  # - !cmd |
  #   echo '▶ (batch-infrastructure) Running cfn-guard security validation...' && \
  #   cfn-guard validate \
  #     --data templates/batch/batch-infrastructure.json \
  #     --rules guard_rules/batch_security_rules.guard \
  #     --show-summary fail && \
  #   echo '✓ (batch-infrastructure) cfn-guard passed'

hooks:
  before_validate: *validation_hooks
  before_create: *validation_hooks
  before_update: *validation_hooks
