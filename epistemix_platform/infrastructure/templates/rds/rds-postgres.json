{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Simple RDS PostgreSQL instance for Epistemix Platform POC",

  "Parameters": {
    "VPCId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC ID for the RDS security group and subnet group"
    },
    "PrivateSubnetIds": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "List of private subnet IDs for the RDS DB subnet group (minimum 2 in different AZs)"
    },
    "DBName": {
      "Type": "String",
      "Default": "epistemixdb",
      "Description": "Database name",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*"
    },
    "DBUsername": {
      "Type": "String",
      "Default": "epistemixuser",
      "Description": "Database master username",
      "MinLength": "1",
      "MaxLength": "63",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*"
    },
    "DBInstanceClass": {
      "Type": "String",
      "Default": "db.t3.micro",
      "Description": "Database instance type",
      "AllowedValues": [
        "db.t3.micro",
        "db.t3.small",
        "db.t3.medium"
      ]
    },
    "AllocatedStorage": {
      "Type": "Number",
      "Default": "20",
      "Description": "Storage size in GB",
      "MinValue": "20",
      "MaxValue": "100"
    },
    "PubliclyAccessible": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Whether the RDS instance should be publicly accessible. Recommended: false for production"
    },
    "DeveloperIP": {
      "Type": "String",
      "Default": "",
      "Description": "Developer IP address for direct database access (optional, e.g., 1.2.3.4/32)",
      "AllowedPattern": "^$|^(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})$"
    },
    "VpcCidr": {
      "Type": "String",
      "Default": "",
      "Description": "Optional VPC CIDR block for database access (e.g., 10.0.0.0/16). Leave empty to disable CIDR-based access.",
      "AllowedPattern": "^$|^(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})$"
    },
    "EnableVPCAccess": {
      "Type": "String",
      "Default": "false",
      "AllowedValues": ["true", "false"],
      "Description": "Allow access from VPC CIDR block (requires VpcCidr parameter)"
    },
    "LambdaSecurityGroupId": {
      "Type": "String",
      "Default": "",
      "Description": "Optional security group ID for Lambda function to allow RDS access"
    },
    "Environment": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": ["dev", "staging", "prod"],
      "Description": "Environment name for tagging"
    }
  },

  "Conditions": {
    "HasLambdaSecurityGroup": {
      "Fn::Not": [
        { "Fn::Equals": [{ "Ref": "LambdaSecurityGroupId" }, ""] }
      ]
    },
    "HasDeveloperIP": {
      "Fn::Not": [
        { "Fn::Equals": [{ "Ref": "DeveloperIP" }, ""] }
      ]
    },
    "HasVpcCidr": {
      "Fn::Not": [
        { "Fn::Equals": [{ "Ref": "VpcCidr" }, ""] }
      ]
    },
    "AllowVPCAccess": {
      "Fn::And": [
        { "Fn::Equals": [{ "Ref": "EnableVPCAccess" }, "true"] },
        { "Condition": "HasVpcCidr" }
      ]
    }
  },

  "Resources": {
    "DBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupName": {
          "Fn::Sub": "epistemix-db-subnet-group-${AWS::StackName}"
        },
        "DBSubnetGroupDescription": "Subnet group for Epistemix RDS PostgreSQL instance",
        "SubnetIds": { "Ref": "PrivateSubnetIds" },
        "Tags": [
          {
            "Key": "Name",
            "Value": "epistemix-db-subnet-group"
          },
          {
            "Key": "Project",
            "Value": "epistemix-platform"
          }
        ]
      }
    },

    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": { "Ref": "VPCId" },
        "GroupDescription": "Security group for RDS PostgreSQL instance with controlled access",
        "Tags": [
          {
            "Key": "Name",
            "Value": "epistemix-rds-sg"
          },
          {
            "Key": "Project",
            "Value": "epistemix-platform"
          }
        ]
      }
    },

    "DBSecurityGroupIngressVPC": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "AllowVPCAccess",
      "Properties": {
        "GroupId": { "Fn::GetAtt": ["DBSecurityGroup", "GroupId"] },
        "IpProtocol": "tcp",
        "FromPort": 5432,
        "ToPort": 5432,
        "CidrIp": { "Ref": "VpcCidr" },
        "Description": "Allow PostgreSQL access from VPC CIDR block"
      }
    },

    "DBSecurityGroupIngressDeveloper": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "HasDeveloperIP",
      "Properties": {
        "GroupId": { "Fn::GetAtt": ["DBSecurityGroup", "GroupId"] },
        "IpProtocol": "tcp",
        "FromPort": 5432,
        "ToPort": 5432,
        "CidrIp": { "Ref": "DeveloperIP" },
        "Description": "Allow PostgreSQL access from developer IP"
      }
    },

    "DBSecurityGroupIngressLambda": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Condition": "HasLambdaSecurityGroup",
      "Properties": {
        "GroupId": { "Fn::GetAtt": ["DBSecurityGroup", "GroupId"] },
        "IpProtocol": "tcp",
        "FromPort": 5432,
        "ToPort": 5432,
        "SourceSecurityGroupId": { "Ref": "LambdaSecurityGroupId" },
        "Description": "Allow PostgreSQL access from Lambda function"
      }
    },

    "DBInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBName": { "Ref": "DBName" },
        "AllocatedStorage": { "Ref": "AllocatedStorage" },
        "DBInstanceClass": { "Ref": "DBInstanceClass" },
        "Engine": "postgres",
        "EngineVersion": "15",
        "MasterUsername": { "Ref": "DBUsername" },
        "MasterUserPassword": {
          "Fn::Sub": "{{resolve:secretsmanager:/epistemix/${Environment}/database/password}}"
        },
        "DBSubnetGroupName": { "Ref": "DBSubnetGroup" },
        "VPCSecurityGroups": [
          { "Fn::GetAtt": ["DBSecurityGroup", "GroupId"] }
        ],
        "PubliclyAccessible": { "Ref": "PubliclyAccessible" },
        "BackupRetentionPeriod": 7,
        "PreferredBackupWindow": "03:00-04:00",
        "PreferredMaintenanceWindow": "sun:04:00-sun:05:00",
        "StorageType": "gp2",
        "StorageEncrypted": true,
        "EnableIAMDatabaseAuthentication": true,
        "DeletionProtection": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": "epistemix-postgres"
          },
          {
            "Key": "Project",
            "Value": "epistemix-platform"
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "Environment" }
          }
        ]
      },
      "DeletionPolicy": "Snapshot"
    }
  },

  "Outputs": {
    "DBEndpoint": {
      "Description": "Database endpoint",
      "Value": { "Fn::GetAtt": ["DBInstance", "Endpoint.Address"] },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-endpoint" }
      }
    },
    "DBPort": {
      "Description": "Database port",
      "Value": { "Fn::GetAtt": ["DBInstance", "Endpoint.Port"] },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-port" }
      }
    },
    "DBName": {
      "Description": "Database name",
      "Value": { "Ref": "DBName" },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-database" }
      }
    },
    "ConnectionString": {
      "Description": "PostgreSQL connection string format (replace PASSWORD)",
      "Value": {
        "Fn::Sub": "postgresql://${DBUsername}:PASSWORD@${DBInstance.Endpoint.Address}:${DBInstance.Endpoint.Port}/${DBName}"
      }
    },
    "SecurityGroupId": {
      "Description": "Security group ID for the RDS instance",
      "Value": { "Fn::GetAtt": ["DBSecurityGroup", "GroupId"] },
      "Export": {
        "Name": { "Fn::Sub": "${AWS::StackName}-SecurityGroupId" }
      }
    }
  }
}