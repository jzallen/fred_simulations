template:
  type: file
  path: api-gateway/epistemix-api-gateway.json

stack_name: epistemix-api-gateway-staging

# Dependencies - Deploy Lambda first, then API Gateway
dependencies: []

# Stack parameters for staging environment
parameters:
  Environment: staging
  ServiceName: epistemix-api
  # Lambda function ARN (using staging alias for version control)
  LambdaFunctionArn: !stack_output_external epistemix-api-lambda-staging::AliasArn
  # CORS origins for staging
  AllowedOrigins: "https://staging.epistemix.io"
  # Stage configuration
  StageName: v1
  ThrottlingBurstLimit: 200
  ThrottlingRateLimit: 100
  # Deployment timestamp - set via environment variable to force new deployments
  # Usage: DEPLOYMENT_TIMESTAMP=$(date +%s) sceptre update staging/api-gateway.yaml
  DeploymentTimestamp: !environment_variable DEPLOYMENT_TIMESTAMP

# Stack-specific tags
tags:
  Owner: fred-simulations
  CostCenter: Staging
  Component: APIGateway
  Service: EpistemixAPI

# Sceptre hooks for template validation
hooks:
  before_validate:
    - !cmd "echo '▶ (api-gateway) Running cfn-lint...' && cfn-lint templates/api-gateway/epistemix-api-gateway.json && echo '✓ (api-gateway) cfn-lint passed'"
    - !cmd "echo '▶ (api-gateway) Running cfn-guard security validation...' && cfn-guard validate --data templates/api-gateway/epistemix-api-gateway.json --rules guard_rules/api_gateway_security_rules.guard --show-summary fail && echo '✓ (api-gateway) cfn-guard passed'"
  before_create:
    - !cmd "echo '▶ (api-gateway) Running cfn-lint...' && cfn-lint templates/api-gateway/epistemix-api-gateway.json && echo '✓ (api-gateway) cfn-lint passed'"
    - !cmd "echo '▶ (api-gateway) Running cfn-guard security validation...' && cfn-guard validate --data templates/api-gateway/epistemix-api-gateway.json --rules guard_rules/api_gateway_security_rules.guard --show-summary fail && echo '✓ (api-gateway) cfn-guard passed'"
  before_update:
    - !cmd "echo '▶ (api-gateway) Running cfn-lint...' && cfn-lint templates/api-gateway/epistemix-api-gateway.json && echo '✓ (api-gateway) cfn-lint passed'"
    - !cmd "echo '▶ (api-gateway) Running cfn-guard security validation...' && cfn-guard validate --data templates/api-gateway/epistemix-api-gateway.json --rules guard_rules/api_gateway_security_rules.guard --show-summary fail && echo '✓ (api-gateway) cfn-guard passed'"
