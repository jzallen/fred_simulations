template:
  type: file
  path: api-gateway/epistemix-api-gateway.json

# Dependencies - Deploy Lambda first, then API Gateway
dependencies:
  - staging/epistemix-api-lambda.yaml

# Stack parameters for development environment
parameters:
  Environment: staging
  ServiceName: epistemix-api
  # Lambda function ARN (resolved via !stack_output from Sceptre-managed stack)
  LambdaFunctionArn: !stack_output staging/epistemix-api-lambda.yaml::FunctionArn
  # CORS origins for development
  AllowedOrigins: "http://localhost:3000,https://localhost:3000,http://localhost:5000,https://localhost:5000"
  # Stage configuration
  StageName: v1
  ThrottlingBurstLimit: 100
  ThrottlingRateLimit: 50

# Stack-specific tags
tags:
  Owner: fred-simulations
  CostCenter: Staging
  Component: APIGateway
  Service: EpistemixAPI

# Sceptre hooks for template validation
validation_hooks: &validation_hooks
  - !cmd |
    echo '▶ (api-gateway) Running cfn-lint...' && \
    cfn-lint templates/api-gateway/epistemix-api-gateway.json && \
    echo '✓ (api-gateway) cfn-lint passed'
  - !cmd |
    echo '▶ (api-gateway) Running cfn-guard security validation...' && \
    cfn-guard validate \
      --data templates/api-gateway/epistemix-api-gateway.json \
      --rules guard_rules/api_gateway_security_rules.guard \
      --show-summary fail && \
    echo '✓ (api-gateway) cfn-guard passed'

hooks:
  before_validate: *validation_hooks
  before_create: *validation_hooks
  before_update: *validation_hooks
