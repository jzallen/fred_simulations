template:
  type: file
  path: lambda/epistemix-api-lambda.json

# Let Sceptre auto-generate stack name (enables !stack_output usage)
# Pattern: <project_code>-<command_path>

# Dependencies - External stacks (ECR, RDS, S3, Batch) must exist before deploying
# Note: API Gateway depends on Lambda, so Lambda is deployed first without API Gateway permission
# Batch dependency ensures VPC endpoint for AWS Batch API is available
dependencies:
  - dev/rds-postgres.yaml
  - dev/s3-upload-bucket.yaml
  - dev/batch-infrastructure.yaml

# Stack parameters for development environment
parameters:
  Environment: dev
  ServiceName: epistemix-api
  # Dynamically fetch ECR image digest for environment-specific tag (:dev)
  # This resolves to immutable digest at deploy time, solving race conditions
  ECRImageUri: !rcmd |
    aws ecr describe-images \
      --repository-name epistemix-api \
      --image-ids imageTag=dev \
      --region us-east-1 \
      --query 'imageDetails[0].imageDigest' \
      --output text | \
    xargs -I {} echo "170692816356.dkr.ecr.us-east-1.amazonaws.com/epistemix-api@{}"
  # VPC configuration
  VPCId: "vpc-00bb33feebfb59191"
  VPCSubnetIds: "subnet-0c6dc4a43d6d2269c,subnet-0065bf40913be1672"
  # RDS connection parameters (dynamically resolved from dev/rds-postgres stack)
  DBSecurityGroupId: !stack_output dev/rds-postgres.yaml::SecurityGroupId
  DBHost: !stack_output dev/rds-postgres.yaml::DBEndpoint
  DBPort: !stack_output dev/rds-postgres.yaml::DBPort
  DBName: !stack_output dev/rds-postgres.yaml::DBName
  DBUser: "epistemixuser"
  # DB_PASSWORD resolved from Secrets Manager at deploy time using CloudFormation dynamic references
  # S3 bucket (dynamically resolved from epistemix-uploads-dev-stack)
  S3BucketName: !stack_output dev/s3-upload-bucket.yaml::BucketName
  MemorySize: 3008
  Timeout: 90

# Stack-specific tags
tags:
  Owner: fred-simulations
  CostCenter: Development
  Component: Lambda
  Service: EpistemixAPI

# Sceptre hooks for template validation
validation_hooks: &validation_hooks
  - !cmd |
    echo '▶ (epistemix-api-lambda) Running cfn-lint...' && \
    cfn-lint templates/lambda/epistemix-api-lambda.json && \
    echo '✓ (epistemix-api-lambda) cfn-lint passed'
  - !cmd |
    echo '▶ (epistemix-api-lambda) Running cfn-guard security validation...' && \
    cfn-guard validate \
      --data templates/lambda/epistemix-api-lambda.json \
      --rules guard_rules/lambda_security_rules.guard \
      --show-summary fail && \
    echo '✓ (epistemix-api-lambda) cfn-guard passed'

hooks:
  before_validate: *validation_hooks
  before_create: *validation_hooks
  before_update: *validation_hooks
